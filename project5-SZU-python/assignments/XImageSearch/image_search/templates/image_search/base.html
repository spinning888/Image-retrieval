<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark light">
  <title>{% block title %}å›¾æœå›¾{% endblock %}</title>
  {% load static %}

  <link id="main-css" rel="stylesheet" href="{% static 'image_search/styles.css' %}?v=20260116-2">

  <style>
    /* critical fallback: prevent layout break if stylesheet fails */
    #sakura-canvas{
      position:fixed; inset:0;
      width:100%; height:100%;
      pointer-events:none;
      z-index:1;
      display:block;
    }
    .bg-blobs{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .container{ position:relative; z-index:10; }
  </style>
</head>

<body>
  <div class="bg-blobs" aria-hidden="true"></div>
  <canvas id="sakura-canvas" class="sakura" aria-hidden="true"></canvas>

  <header class="header">
    <nav class="nav">
      <a class="brand" href="/" aria-label="å›åˆ°é¦–é¡µ">
        <span class="dot" aria-hidden="true"></span>
        <span>Image Search</span>
      </a>

      <div class="links" role="navigation" aria-label="ä¸»å¯¼èˆª">
        <a class="navlink" href="/" data-nav="/">é¦–é¡µ</a>
        <a class="navlink" href="/history/" data-nav="/history/">æœç´¢å†å²</a>
        <a class="navlink" href="/favorites/" data-nav="/favorites/">æ”¶è—å¤¹</a>
        <a class="navlink" href="/results/" data-nav="/results/">ç»“æœ</a>
      </div>

      <div class="nav-aux">
        <button id="sakura-toggle" class="button ghost iconbtn" type="button" aria-label="æ¨±èŠ±ç‰¹æ•ˆå¼€å…³" title="æ¨±èŠ±ç‰¹æ•ˆå¼€å…³">ğŸŒ¸</button>
        <button id="theme-toggle" class="button ghost iconbtn" type="button" aria-label="ä¸»é¢˜åˆ‡æ¢" title="ä¸»é¢˜åˆ‡æ¢">â˜¾</button>
        <a class="button primary" href="/" title="å¿«æ·é”® Ctrl/Command + O é€‰æ‹©å›¾ç‰‡">
          ä¸Šä¼ æœç´¢ <span class="kbd">Ctrl/Command O</span>
        </a>
      </div>
    </nav>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <script src="{% static 'image_search/ui.js' %}?v=20260116-2"></script>

  <script>
    (function(){
      // æ›´ç¨³çš„æ ·å¼åŠ è½½æ£€æµ‹ï¼šæ£€æŸ¥å…³é”® CSS å˜é‡æ˜¯å¦å­˜åœ¨
      function ensureStyles(){
        const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
        if (bg) return;

        const main = document.getElementById('main-css');
        const href = main?.href;
        if (!href) return;

        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = href.split("?")[0] + "?v=" + Date.now(); // bust cache
        document.head.appendChild(link);
        console.warn("[UI] styles.css not applied, injected fallback:", link.href);
      }
      ensureStyles();

      window.UI && UI.initTheme();
      document.getElementById('theme-toggle')?.addEventListener('click', ()=> UI.toggleTheme());

      var path = window.location.pathname || "/";
      document.querySelectorAll('[data-nav]').forEach(function(a){
        var p = a.getAttribute('data-nav');
        if (p === "/" ? path === "/" : path.startsWith(p)) a.classList.add('active');
      });

      UI.initSpotlight();
      UI.bindRipple();
      UI.bindEntrance();
      UI.bindTilt('.item');
      UI.bindImageGridViewer(document);

      UI.initSakura({ canvasId: 'sakura-canvas' });
      document.getElementById('sakura-toggle')?.addEventListener('click', ()=> UI.toggleSakura());
    })();
  </script>
</body>
</html>
